{{- $did := .Get "did" | default (.Get 0) -}}
{{- $rkey := .Get "rkey" | default (.Get 1) -}}
{{- $uri := printf "at://%s/app.bsky.feed.post/%s" $did $rkey -}}
{{- $apiURL := printf "https://public.api.bsky.app/xrpc/app.bsky.feed.getPostThread?uri=%s&depth=0" $uri -}}

{{- $data := dict -}}
{{- with try (resources.GetRemote $apiURL) -}}
  {{- with .Value -}}
    {{- $json := .Content | transform.Unmarshal -}}
    {{- $data = $json.thread.post -}}
  {{- end -}}
{{- end -}}

{{- if $data -}}
<article class="bluesky-card outlined-card" lang="{{ $data.record.langs | first 1 | default "en" }}">
  <header class="bluesky-header">
    <div class="bluesky-author">
      {{- $avatar := resources.GetRemote $data.author.avatar -}}
      {{- if $avatar -}}
        <img src="{{ $avatar.RelPermalink }}" alt="" class="u-photo" width="48" height="48" loading="lazy">
      {{- else -}}
        <div class="u-photo-placeholder">?</div>
      {{- end -}}
      
      <div class="author-meta">
        <a href="https://bsky.app/profile/{{ $data.author.handle }}" class="p-name u-url" target="_blank" rel="noopener noreferrer">
          <strong>{{ $data.author.displayName | default $data.author.handle }}</strong>
        </a>
        <span class="p-nickname">@{{ $data.author.handle }}</span>
      </div>
    </div>
    <div class="social-logo" aria-label="Bluesky Post">
      {{ partial "icons/bluesky.svg" . }}
    </div>
  </header>

  <div class="e-content">
    {{ (replace $data.record.text "\n" "<br>") | safeHTML }}
  </div>

  {{- /* MEDIA HANDLING: Images & Video */ -}}
  {{- with $data.embed -}}
    <div class="bluesky-media">
      {{- if eq . "$type" "app.bsky.embed.images#view" -}}
        {{- range .images -}}
          {{- with resources.GetRemote .thumb -}}
            <div class="media-item">
              <img src="{{ .RelPermalink }}" class="u-photo" alt="{{ .alt | default "Bluesky image" }}" loading="lazy">
            </div>
          {{- end -}}
        {{- end -}}
      {{- else if eq . "$type" "app.bsky.embed.video#view" -}}
        {{- $v_thumb := resources.GetRemote .thumbnail -}}
        <div class="bluesky-video-facade media-item" data-playlist="{{ .playlist }}">
          {{- if $v_thumb -}}
            <img src="{{ $v_thumb.RelPermalink }}" class="u-photo" alt="Video Thumbnail" loading="lazy">
          {{- end -}}
          <div class="play-overlay"><span>▶</span></div>
          <a href="https://bsky.app/profile/{{ $data.author.handle }}/post/{{ $rkey }}" class="u-video" style="display:none;" aria-hidden="true">Watch on Bluesky</a>
        </div>
      {{- end -}}
    </div>
  {{- end -}}

  <footer class="bluesky-footer">
    <time class="dt-published" datetime="{{ $data.record.createdAt }}">
      {{ dateFormat "Jan 02, 2006" $data.record.createdAt }}
    </time>
    <div class="social-stats">
      <span>↩ {{ $data.replyCount }}</span>
      <span>↻ {{ $data.repostCount }}</span>
      <span>♥ {{ $data.likeCount }}</span>
    </div>
    <a href="https://bsky.app/profile/{{ $data.author.handle }}/post/{{ $rkey }}" class="button-small" target="_blank" rel="noopener noreferrer">View Original</a>
  </footer>
</article>
{{- else -}}
<div class="bluesky-card error outlined-card">
  <p><strong>Error:</strong> Could not fetch Bluesky post.</p>
  <p><a href="https://bsky.app/profile/{{ $did }}/post/{{ $rkey }}">View on Bluesky</a></p>
</div>
{{- end -}}
